<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>俄罗斯方块</title>
</head>

<body>
  <!-- 游戏区域 -->
  <div class="area">
  </div>
  <!-- 死亡区域 -->
  <div class="death"></div>
  <style>
    * {
      padding: 0;
      margin: 0;
    }

    .area {
      width: 500px;
      height: 1000px;
      display: flex;
      flex-wrap: wrap;
    }

    .death {
      font-size: 20px;
    }
  </style>


  <script>
    //获取元素
    const area = document.querySelector('.area')
    const death = document.querySelector('.death')
    //触底时采用另一种数组存储
    //用tArr[y][x]=1 来表示这个坐标下有小方块
    let tArr = [[], []]

    //开局初始化tArr
    start()
    function start() {
      for (let i = 0; i < 50; i++) {
        tArr[i] = []
        for (let j = 0; j < 25; j++) {
          tArr[i][j] = 0
        }
      }
    }

    //获取方向
    let d = ''
    let r = ''

    document.addEventListener('keydown', (e) => {
      //平移方向
      if (e.key === 'a') {
        d = 'left'
      }
      //按右键
      if (e.key === 'd') {
        d = 'right'
      }

      //旋转方向
      if (e.key === 'ArrowLeft') {
        r = 'left'
      }
      if (e.key === 'ArrowRight') {
        r = 'right'
      }
      if (e.key === 'ArrowUp') {
        r = 'up'
      }
      if (e.key === 'ArrowDown') {
        r = 'down'
      }
    })


    //生成方块函数
    let arr = []
    let b = 0  //下落随时间累加的y坐标
    let a = 0 //随机的x坐标
    let c = 0 //方块种类 (旋转时方块的状态)

    function random() {
      let num = []
      b = 0
      //生成随机坐标
      // a = Math.floor(Math.random() * 24)
      a = 20
      c = 1
      c = Math.floor(Math.random() * 4 + 1)
      //生成随机种类的方块
      if (c === 1) {
        num = [0, 2, 0, 3]
      }
      else if (c === 2) {
        num = [1, 1, 1, 2]
      }
      else if (c === 3) {
        num = [1, 0, 1, 1]
      }
      else if (c === 4) {
        num = [0, 2, 1, 2]
      }
      arr = [[a, b], [a, b + 1],
      [a + num[0], b + num[1]], [a + num[2], b + num[3]]]
      return arr
    }
    //开局生成随机方块
    random()



    //旋转
    function rotate() {
      //根据方块种类和旋转方向改变数组 
      if (c === 1) {
        a = arr[1][0]
        b = arr[1][1] - 1
        if ((r === 'left' || r === 'right')) {
          arr = [
            [a, b + 1],
            [a + 1, b + 1],
            [a + 2, b + 1],
            [a + 3, b + 1],
          ]

        }
        //第一种按上下还会还原成之前的样子 
        else if (r === 'up' || r === 'down') {
          arr = [
            [a, b],
            [a, b + 1],
            [a, b + 2],
            [a, b + 3]]
        }
      }

      else if (c === 2) {
        a = arr[1][0]
        b = arr[1][1] - 1
        if (r === 'left') {
          arr = [
            [a + 1, b],
            [a, b],
            [a, b + 1],
            [a - 1, b + 1],
          ]
        }
        else if (r === 'right') {
          arr = [
            [a - 1, b],
            [a, b],
            [a, b + 1],
            [a + 1, b + 1],
          ]
        }
        //第二种按上下还会还原成之前的样子 
        else if (r === 'up' || r === 'down') {
          arr = [
            [a, b],
            [a, b + 1],
            [a + 1, b + 1],
            [a + 1, b + 2]]
        }
      }
      else if (c === 4) {
        a = arr[2][0]
        b = arr[2][1] - 2
        console.log('旋转值', a, b);

        if (r === 'left') {
          arr = [
            [a - 2, b + 2],
            [a - 1, b + 2],
            [a, b + 2],
            [a, b + 1],
          ]
        }
        else if (r === 'right') {
          arr = [
            [a, b + 3],
            [a, b + 2],
            [a + 1, b + 2],
            [a + 2, b + 2],
          ]
        }
        else if (r === 'down') {
          arr = [
            [a - 1, b + 2],
            [a, b + 2],
            [a, b + 3],
            [a, b + 4],
          ]
        }
      }
      render()
    }




    //变量b随时间累加
    const timer = setInterval(() => {
      //如果触底或者碰撞
      if (arr[arr.length - 1][1] === 49 ||
        touchJudge(tArr, arr[arr.length - 1][0], arr[arr.length - 1][1] + 1)) {
        touch()//生成碰撞之后的数组
        eJudge()//判断和处理消除
        random() //继续生成随机方块
        //判断死亡
        if (tArr[0].some((value) => value === 1)) {
          deathWarning()//触发死亡效果
        }
      } else {
        //3 旋转
        if (r) {
          rotate(arr)
        }
        //每秒arr都要改变
        for (let j in arr) {

          //1 下落
          arr[j][1]++

          //2 平移 只对数据进行一次处理
          if (d === 'left') {
            arr[j][0] = arr[j][0] - 1
          }
          if (d === 'right') {
            arr[j][0] = arr[j][0] + 1
          }
          render()
        }
        d = ''
        r = ''
      }
    }, 100)


    //判断方块渲染
    function judge(arr, x, y) {
      for (let i in arr) {
        if (arr[i][0] === x && arr[i][1] === y) {
          return true
        }
      }
    }
    //判断触底方块渲染
    function touchJudge(tArr, x, y) {
      for (let i in tArr) {
        for (let j in tArr[i]) {
          //如果对应的位置有坐标
          if (tArr[y][x] === 1) {
            return true
          }
        }
      }
    }
    //判断处理消除
    function eJudge() {
      for (let n in tArr) {
        //如果这一行每个元素都为一
        if (tArr[n].every((value) => value === 1)) {
          for (let i = n; i > 0; i--) {
            tArr[i] = tArr[i - 1]
          }
          for (let m in arr[0]) {
            tArr[0][m] = 0
          }
        }
      }
    }




    //渲染游戏区域
    function render() {
      let block = ''
      for (let y = 0; y < 50; y++) {
        for (let x = 0; x < 25; x++) {
          //渲染四种方块
          if (judge(arr, x, y)) {
            block += ` <div style="width:20px;height:20px;background-color: #00fdff;"></div>`
          }
          //渲染触底方块 
          else if (touchJudge(tArr, x, y)) {
            block += ` <div style="width:20px;height:20px;background-color: pink;"></div>`
          }
          //渲染黑色背景板
          else {
            block += ` <div style="width:20px;height:20px;background-color: #000;"></div>`
          }
        }
      }
      area.innerHTML = block
    }
    //开局先渲染
    render()


    //触底 处理
    function touch() {
      //每次触底都把相应数据存进去
      for (let i = 0; i < 50; i++) {
        for (let j = 0; j < 25; j++) {
          for (let k = 0; k < arr.length; k++) {
            if (i === arr[k][1] && j === arr[k][0]) {
              tArr[i][j] = 1
            }
          }
        }
      }
      //渲染触底的部分
      render()
    }

    //死亡效果
    function deathWarning() {
      clearInterval(timer)
      death.innerHTML = '游戏结束'
    }
  </script>
</body>

</html>